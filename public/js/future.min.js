/*! koa 0.0.1 */
var future=angular.module("future",["ngResource","ngRoute","future.index","progress"]);angular.module("progress",[]).service("ngProgress",function(){var el=document.getElementById("progress"),w=window.innerWidth,start=0,state="uncomplete",time=100,run=function(){start+=25,"uncomplete"==state&&time++,"completed"==state&&(time=1),el.style.width=start+"px",w>start?setTimeout(run,10):(el.style.width="0px",start=0,time=100,state="uncomplete")};return{start:function(){state="uncomplete",run()},complete:function(){state="completed"}}}),angular.module("future.index",[]);var errorcb=function(){alert("server error")};angular.module("future.index").controller("exchangeController",function($scope,$http,$route){function update(){$http.get("/exchangedata/"+name).success(function(data){$scope.ask=filter(data.ask),$scope.bid=filter(data.bid),$scope.coins=data.coins}),$http.get("/history/"+name).success(function(data){$scope.his=data}),$http.get("/myhistory/"+name).success(function(data){$scope.myhis=data})}function filter(arr){for(var current,temp,newarr=[];arr.length;)temp=arr.shift(),current&&current.price==temp.price?current.amount=parseFloat(current.amount)+parseFloat(temp.amount):(current=temp,newarr.push(current));return console.log(newarr),newarr}var name=$route.current.params.name;console.log(name),$scope.user={btc:(100*Math.random()).toFixed(8),coin:Math.ceil(1e5*Math.random())},$scope.coin=name,$scope.balance=$scope.user.coin,$scope.buy={amount:"0.00000000",price:"0.00010000",total:"0.00000000"},$scope.sell={amount:"0.00000000",price:"0.00010000",total:"0.00000000"},$scope.completebid=function(){$scope.buy.amount=($scope.user.btc/$scope.buy.price).toFixed(8),$scope.buy.total=$scope.user.btc},$scope.completeask=function(){$scope.sell.amount=$scope.user.coin,$scope.sell.total=($scope.user.coin*$scope.sell.price).toFixed(8)},$scope.sellthis=function(order){$scope.sell.price=order.price,$scope.sell.amount=order.amount},$scope.buythis=function(order){$scope.buy.price=order.price,$scope.buy.amount=order.amount},$scope.redirect=function(name){location.href="/BTC/"+name},$scope.process=function(type){var btc=$scope[type].price*$scope[type].amount,data={};isNaN(btc)||(data.price=Number($scope[type].price).toFixed(8),data.amount=Number($scope[type].amount).toFixed(8),data.name=$scope.coin,data.type=type,$http.post("/trade",data,csrfconfig).success(function(data){$scope[type].amount="0.00000000",$scope[type].total="0.00000000",setTimeout(update,800)}))},update(),setInterval(update,4e3)}),angular.module("future.index").controller("userController",function($scope,$http,$route){var emailregx=/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;$scope.signup=function(){var email=$scope.mail,password=$scope.password,repassword=$scope.repassword;return emailregx.test(email)?!password||password.length<6?void($scope.tips="Password must be 6 char +"):password!=repassword?void($scope.tips="密码不一致"):($scope.tips="",void $http.post("/newuser",{mail:email,password:password},csrfconfig).success(function(data){data.status?($scope.tips=data.msg,$scope.success=""):($scope.tips="注册成功，请登录邮箱激活",$scope.success="success")}).error(errorcb)):void($scope.tips="Invild Email Address")}}),Number.prototype.satoshi=function(){return this};var csrfconfig={headers:{"X-Csrf-Token":document.getElementById("token").value}};future.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"/templates/index.html",title:"Future"}).when("/BTC/:name",{templateUrl:"/templates/exchange.html",title:"Future"}).when("/signup",{templateUrl:"/templates/signup.html",title:"Signup | Future"})}),future.config(function($locationProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!1})}).run(function($rootScope,$route,$location,$routeParams,ngProgress){$rootScope.$on("$routeChangeStart",function(){ngProgress.start()}),$rootScope.$on("$routeChangeSuccess",function(){ngProgress.complete(),$rootScope.titleDetail="",$rootScope.title=$route.current.title,$rootScope.isCollapsed=!0,$rootScope.currentAddr=null})}),future.directive("a",function(){return{restrict:"E",link:function(scope,elem,attrs){(attrs.ngClick||""===attrs.href||"#"===attrs.href)&&elem.on("click",function(e){e.preventDefault()})}}});